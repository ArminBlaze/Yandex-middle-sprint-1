<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<style>
		html, body {
			margin: 0;
			padding: 0;
			width: 100%;
		}

		.auth__elem {
			display: flex;
			flex-direction: column;
			padding-top: 20px;
		}

		.auth__header {
			text-align: center;
		}

		.auth__Form {
			margin: 0 auto;
		}

		.auth__Form label {
			display: block;
			margin-bottom: 10px;
		}

		.id {
			display: none;
			text-align: center;
		}
	</style>
</head>
<body>
	<div class="wrapper">

		<div class="auth">
			<div class="login auth__elem">
				<h2 class="login__header auth__header">Вход</h2>
				<form class="loginForm auth__Form" action="">
					<label>
						Логин
						<input type="text" name="login">
					</label>
					<label>
						Пароль
						<input type="password" name="password">
					</label>
					<button type="submit">Зайти</button>
				</form>
			</div>
	
			<div class="register auth__elem">
				<h2 class="register__header auth__header">Регистрация</h2>
				<form class="registerForm auth__Form" action="">
					<label>
						Имя
						<input type="text" name="first_name">
					</label>
					<label>
						Фамилия
						<input type="text" name="second_name">
					</label>
					<label>
						Логин
						<input type="text" name="login">
					</label>
					<label>
						Электронная почта
						<input type="email" name="email">
					</label>
					<label>
						Телефон
						<input type="tel" name="phone">
					</label>
					<label>
						Пароль
						<input type="password" name="password">
					</label>
					<label>
						Повторите пароль
						<input type="password" name="password2">
					</label>
					<button type="submit">Зайти</button>
				</form>
			</div>
		</div>

		<div class="id"></div>
</div>
</body>

<script>
	window.onload = function() {
		autoLogin();
	};

	const host = 'https://ya-praktikum.tech';

	const loginForm = document.querySelector('.loginForm');
	const registerForm = document.querySelector('.registerForm');
	const authBlock = document.querySelector('.auth');

	// при загрузке страницы нужно пытаться получить id пользователя.
	// если успешно, то форму логина нужно скрыть

	let loggedIn = false;
	let userId = null;

	const state = {
		userId: null,
		isLoggedIn: false,
	}

	function afterLogin(id) {
		state.loggedIn = true;
		state.userId = id;
		hideAuthBlock();
		showUserId(id);
	}

	function hideAuthBlock() {
		authBlock.style.display = "none";
	}

	function showUserId(id) {
		const idBlock = document.querySelector('.id')
		idBlock.style.display = "block"
		idBlock.textContent = "UserID: " + id;
	}

	async function autoLogin() {
		console.log('запускаю автологин');
		const id = await getUserData();
		console.log("ID в AUTOLOGIN", id);

		if(id) {
			afterLogin(id);
		}
	}


	loginForm.addEventListener('submit', (event) => {
		event.preventDefault();
		
		console.log(loginForm.login.value);
		console.log(loginForm.password.value);

		const data = {
			login: loginForm.login.value,
			password: loginForm.password.value
		}

			makeLogin(data)
			.then(data => {
				getUserData();
			});

	})

	registerForm.addEventListener('submit', (event) => {
		event.preventDefault();
		
		console.log();

		const password = registerForm.password.value;
		const password2 = registerForm.password2.value;

		if(password !== password2) {
			alert("Пароли должны совпадать!")
			return;
		}

		const data = {
			first_name: registerForm.first_name.value,
			second_name: registerForm.second_name.value,
			login: registerForm.login.value,
			email: registerForm.email.value,
			password: password,
			phone: registerForm.phone.value
		}


		console.log(data);
		makeRegister(data)
			.then(async data =>  {
				const id = await getUserData();
				if(id) {
					afterLogin(id);
				}
			});

	})

	function makeLogin(data) {
		const json = JSON.stringify(data) 

		return fetch(`${host}/api/v2/auth/signin`, {
			method: 'POST',
			credentials: 'include', // Нужно подставлять куки
			mode: 'cors', // Работаем с CORS
			headers: {
				'content-type': 'application/json', // Данные отправляем в формате JSON
			},
			body: json
		})
			.then(response => response.text()) // Можно вытащить через .json()
			.then(data => {
				console.log(data);
				return data;
			})
		
	}

	function makeRegister(data) {
		const json = JSON.stringify(data) 

		return fetch(`${host}/api/v2/auth/signup`, {
			method: 'POST',
			credentials: 'include', // Нужно подставлять куки
			mode: 'cors', // Работаем с CORS
			headers: {
				'content-type': 'application/json', // Данные отправляем в формате JSON
			},
			body: json
		})
			.then(response => response.text()) // Можно вытащить через .json()
			.then(data => {
				console.log(data);
				return data;
			})
		
	}

	async function getUserData() {
		return fetch(`${host}/api/v2/auth/user`, { // Получаем подробную информацию о пользователе и проверяем, что куки проставились
			method: 'GET',
			mode: 'cors',
			credentials: 'include',
		})
		.then(r => r.json())
		.then(data => {
			console.log('user', data);
			const id = data.id;
			console.log('ID', id);
			return id;
		});
	}
</script>
</html>